{% extends "layout.html" %}
{% block title %}{{ job.title }} — GetAJob{% endblock %}

{% block content %}
<div style="display:flex; gap:18px;">
  <div style="flex:1;">
    <h2>{{ job.title }}</h2>
    <div class="text-muted" style="margin-bottom:8px;">
      {% if job.location_text %}{{ job.location_text | short_addr }}{% endif %}
      {% if job.tags %} • {{ job.tags }}{% endif %}
    </div>

    <div class="card">
      <h3>Description</h3>
      <div>{{ job.description }}</div>
    </div>

    <div style="margin-top:12px;">
      {% if current_user.is_authenticated and (current_user.get_id()|int) != (job.employer_id|int) %}
        <a class="btn btn-outline" href="{{ url_for('messages_page') }}?other_id={{ job.employer_id|int }}">Message Poster</a>

        {# Apply button / form: only visible to contractors, not to clients or job owner #}
        {% if current_user.is_authenticated and (current_user.role|default('')|lower) == 'contractor' %}
          <form method="post" action="{{ url_for('apply_job', job_id=job.id) }}" style="display:inline-block; margin-left:8px;">
            <input type="hidden" name="job_id" value="{{ job.id }}">
            <button type="submit" class="btn btn-primary">Apply</button>
          </form>
        {% endif %}
      {% endif %}

      {% if is_owner %}
        <a class="btn btn-outline" href="{{ url_for('edit_job', job_id=job.id) }}">Edit</a>
        <a class="btn btn-outline" href="{{ url_for('job_applicants', job_id=job.id) }}" style="margin-left:8px;">View applicants</a>
      {% endif %}
    </div>

    {# Full application form with file uploads: only for contractors and not job owner #}
    {% if current_user.is_authenticated and (current_user.role|default('')|lower) == 'contractor' and (current_user.get_id()|int) != (job.employer_id|int) %}
      <div style="margin-top:16px;">
        <h4>Apply with files</h4>
        <form method="post" action="{{ url_for('apply_job', job_id=job.id) }}" enctype="multipart/form-data">
          <label for="cover_letter_file">Cover Letter (PDF only)</label>
          <input id="cover_letter_file" name="cover_letter_file" type="file" accept="application/pdf, .pdf">

          <label for="resume_file" style="margin-top:10px; display:block;">Resume (PDF only)</label>
          <input id="resume_file" name="resume_file" type="file" accept="application/pdf, .pdf">

          <div style="margin-top:8px;">
            <button type="submit" class="btn btn-primary">Submit application</button>
          </div>
        </form>
      </div>
    {% endif %}
  </div>

  <aside style="width:260px;">
    <div class="card">
      <div><strong>Employer</strong></div>
      {% if employer %}
        <div>{{ employer.username or employer.first_name or employer.email }}</div>
      {% else %}
        <div><em>Employer account not available</em></div>
      {% endif %}
      <div style="margin-top:8px;"><small class="text-muted">Posted {{ job.created_at|date_only }}</small></div>
    </div>
  </aside>
</div>
{% endblock %}
