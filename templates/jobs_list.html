{% extends "layout.html" %}
{% block title %}Jobs — GetAJob{% endblock %}

{% block content %}
<h2 style="color:var(--primary); margin-bottom:12px;">Jobs</h2>

<div class="card" style="margin-bottom:18px;">
  <form id="filters" method="get" action="{{ url_for('jobs_list') }}" style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
    <input type="text" name="q" placeholder="Search title, description or tags" value="{{ q }}" class="input" style="flex:2; min-width:180px;">
    <input type="text" name="tags" placeholder="Tags (comma separated)" value="{{ tags }}" class="input" style="flex:1; min-width:160px;">
    <input type="hidden" id="latInput" name="lat" value="{{ lat or '' }}">
    <input type="hidden" id="lngInput" name="lng" value="{{ lng or '' }}">
    <input type="number" name="radius_miles" placeholder="Radius (miles)" class="input" style="width:140px;" value="{{ radius_miles or '' }}">
    <select name="sort" class="input" style="width:140px;">
      <option value="date" {% if sort=='date' %}selected{% endif %}>Newest</option>
      <option value="distance" {% if sort=='distance' %}selected{% endif %}>Distance</option>
    </select>
    <div style="display:flex; gap:8px;">
      <button type="submit" class="btn btn-primary">Apply</button>
    </div>
  </form>
</div>

<p class="small text-muted">Showing {{ jobs|length }} of {{ total }} results</p>

<ul class="job-list" style="margin-top:8px;">
  {% for job in jobs %}
    <li class="job-item">
      <div style="flex:1;">
        <a href="{{ url_for('job_detail', job_id=job.id) }}" class="title">{{ job.title }}</a>
        <div class="text-muted">
          {% if job.location_text %}
            {{ job.location_text | short_addr }}
          {% endif %}
          {% if job.tags %} • {{ job.tags }}{% endif %}
        </div>
        <div style="margin-top:8px;">{{ job.description[:240] }}{% if job.description|length > 240 %}...{% endif %}</div>
      </div>

      <div class="meta" style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        {% if job._distance_miles is not none %}
          <div style="font-weight:700;">{{ job._distance_miles }} mi</div>
        {% endif %}
        <div class="text-muted">{{ job.created_at|date_only }}</div>

        <!-- Message button: opens Messages UI and requests conversation with the job poster -->
        {% if current_user.is_authenticated and (current_user.get_id()|int) != (job.employer_id|int) %}
          <a class="btn btn-outline" href="{{ url_for('messages_page') }}?other_id={{ job.employer_id|int }}">Message Poster</a>

          {# Contractors get an Apply link that opens the job_detail where they can include a cover letter.
              Clients (job listers) do NOT see the apply link for their own postings. #}
          {% if (current_user.role|default('')|lower) == 'contractor' %}
            <a class="btn btn-primary" href="{{ url_for('job_detail', job_id=job.id) }}" style="margin-top:6px;">Apply</a>
          {% endif %}
        {% endif %}
      </div>
    </li>
  {% endfor %}
</ul>
{% endblock %}
